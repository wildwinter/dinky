"use strict";const r=require("electron"),l=require("path"),u=require("fs/promises"),G=require("fs"),I=require("inkjs/full"),L=l.join(r.app.getPath("userData"),"config.json"),q=10;let b=null,S=null,O=Promise.resolve(),F=null;async function E(){return b||S||(S=(async()=>{try{const t=await u.readFile(L,"utf-8");return b=JSON.parse(t),b}catch{return b={theme:"system",recentProjects:[],projectSettings:{},windowStates:{}},b}finally{S=null}})(),S)}async function Z(t,e){const n=await E();return!n.projectSettings||!n.projectSettings[t]?null:n.projectSettings[t][e]}async function U(t,e,n){const o=await E();o.projectSettings||(o.projectSettings={}),o.projectSettings[t]||(o.projectSettings[t]={}),o.projectSettings[t][e]=n,await g(o)}async function g(t,e=!1){return b||await E(),t.projectSettings&&(b.projectSettings={...b.projectSettings||{},...t.projectSettings}),t.windowStates&&(b.windowStates={...b.windowStates||{},...t.windowStates}),Object.keys(t).forEach(n=>{n!=="projectSettings"&&n!=="windowStates"&&(b[n]=t[n])}),F&&(clearTimeout(F),F=null),e?P():new Promise(n=>{F=setTimeout(()=>{n(P())},500)})}async function P(){return O=O.then(async()=>{const t=`${L}.tmp`;try{await u.writeFile(t,JSON.stringify(b,null,2)),await u.rename(t,L)}catch(e){console.error("Failed to save settings:",e);try{await u.unlink(t)}catch{}}}),O}async function K(){F&&(clearTimeout(F),F=null,await P()),await O}async function $(t){const e=await E();return e.windowStates?e.windowStates[t]:null}async function R(t,e){const n={};n[t]=e,await g({windowStates:n})}async function N(){return(await E()).recentProjects||[]}async function ee(t){let e=await N();e=e.filter(n=>n!==t),e.unshift(t),e.length>q&&(e=e.slice(0,q)),await g({recentProjects:e},!0)}async function H(t){let e=await N();e=e.filter(n=>n!==t),await g({recentProjects:e},!0)}function d(t,e,...n){return t&&!t.isDestroyed()&&t.webContents&&!t.webContents.isDestroyed()?(t.webContents.send(e,...n),!0):!1}function V(t,e,n){const o=()=>{const a=r.nativeTheme.shouldUseDarkColors?"vs-dark":"vs";d(t,"theme-updated",a)&&t&&!t.isDestroyed()&&e&&n&&t.setBackgroundColor(r.nativeTheme.shouldUseDarkColors?e:n)};return r.nativeTheme.on("updated",o),o(),{cleanup:()=>{r.nativeTheme.off("updated",o)},update:o}}let j=null,y=null,T=null;function te(t){T=t}function ne(){return j}async function x(t){const e=l.dirname(t),n=[],o=new Set;async function a(s){if(!o.has(s)){o.add(s);try{const i=await u.readFile(s,{encoding:"utf-8"}),c=l.relative(e,s);n.push({absolutePath:s,relativePath:c===""?l.basename(s):c,content:i});const f=i.split(/\r?\n/);for(const m of f){const C=m.match(/^\s*INCLUDE\s+(.+)/);if(C){const v=C[1].trim(),w=l.resolve(l.dirname(s),v);await a(w)}}}catch{}}}return await a(t),n}async function D(t,e){try{try{await u.access(e)}catch{throw new Error(`Project file not found: ${e}`)}const o=(await u.readFile(e,"utf-8")).replace(/\/\/.*$/gm,"").replace(/\/\*[\s\S]*?\*\//g,"");j={path:e,content:JSON.parse(o)},t.isDestroyed()||t.setTitle(`Dinky - ${l.basename(e,".dinkproj")}`),await ee(e),T&&await T(t);const a=await Z(e,"lastInkRoot");let s=null;if(a)try{await u.access(a),s=a}catch{}if(!s&&j.content.source){const i=l.resolve(l.dirname(e),j.content.source);try{await u.access(i),s=i}catch{}}if(s){y=s;const i=await x(s);d(t,"root-ink-loaded",i),d(t,"project-loaded",{hasRoot:!0})}else d(t,"project-loaded",{hasRoot:!1});return!0}catch(n){return console.error("Failed to open project:",n),n.message.includes("not found")&&(await H(e),T&&await T(t)),r.dialog.showErrorBox("Error",`Failed to open project file.
${n.message}`),!1}}async function oe(t,e,n){if(!e||!n)return!1;const o=l.join(n,e),a=l.join(o,`${e}.dinkproj`),s=l.join(o,"main.ink");try{await u.mkdir(o,{recursive:!0});const i={source:"main.ink"};return await u.writeFile(a,JSON.stringify(i,null,2),"utf-8"),await u.writeFile(s,"// Add Ink content here","utf-8"),await U(a,"lastInkRoot",s),await D(t,a),!0}catch(i){return console.error("Failed to create new project:",i),r.dialog.showErrorBox("Error",`Failed to create new project: ${i.message}`),!1}}async function re(t,e,n){if(!e||!n||!y)return!1;const o=e.endsWith(".ink")?e:`${e}.ink`,a=l.join(n,o);try{await u.writeFile(a,"// Type Ink here","utf-8");const i=(await u.readFile(y,"utf-8")).split(/\r?\n/),f=`INCLUDE ${l.relative(l.dirname(y),a).replace(/\\/g,"/")}`;let m=-1;for(let w=i.length-1;w>=0;w--)if(i[w].trim().startsWith("INCLUDE ")){m=w+1;break}if(m===-1){m=0;for(let w=0;w<i.length;w++){const W=i[w].trim();if(W.startsWith("//")||W==="")m=w+1;else break}}i.splice(m,0,f);const C=i.join(`
`);await u.writeFile(y,C,"utf-8");const v=await x(y);return d(t,"root-ink-loaded",v),!0}catch(s){return console.error("Failed to add new include:",s),r.dialog.showErrorBox("Error",`Failed to add new include: ${s.message}`),!1}}async function ae(t){const e=ne(),n=e?l.dirname(e.path):void 0,{canceled:o,filePaths:a}=await r.dialog.showOpenDialog(t,{defaultPath:n,properties:["openFile"],filters:[{name:"Ink Files",extensions:["ink"]}]});if(!o&&a.length>0){const s=await x(a[0]);d(t,"root-ink-loaded",s),d(t,"project-loaded",{hasRoot:!0}),e&&(await U(e.path,"lastInkRoot",a[0]),console.log("Saved Ink Root preference:",a[0]))}}function Q(t){if(!y){r.dialog.showErrorBox("Error","No Ink project loaded. Please open a project first.");return}const e=l.dirname(y);d(t,"show-new-include-modal",e)}async function ie(t){if(!j)return r.dialog.showErrorBox("Error","No project loaded."),!1;const e=j.path,n=l.dirname(e),o=l.join(n,"main.ink");try{try{await u.access(o);const{response:s}=await r.dialog.showMessageBox(t,{type:"warning",buttons:["Cancel","Overwrite"],defaultId:0,title:"File Exists",message:"main.ink already exists. Do you want to overwrite it?"});if(s===0)return!1}catch{}await u.writeFile(o,"// Add Ink content here","utf-8"),j.content.source="main.ink",await u.writeFile(e,JSON.stringify(j.content,null,2),"utf-8"),await U(e,"lastInkRoot",o);const a=await x(o);return y=o,d(t,"root-ink-loaded",a),d(t,"project-loaded",{hasRoot:!0}),!0}catch(a){return console.error("Failed to create ink root:",a),r.dialog.showErrorBox("Error",`Failed to create ink root: ${a.message}`),!1}}async function se(t,e){if(!y||!e)return!1;if(e===y)return r.dialog.showErrorBox("Error","Cannot delete the main Ink Root file."),!1;const n=l.basename(e),{response:o}=await r.dialog.showMessageBox(t,{type:"question",buttons:["Cancel","Delete"],defaultId:0,title:"Delete File",message:`Are you sure you want to delete file "${n}"?`,detail:"This action cannot be undone. The file will be deleted and the INCLUDE line removed from the root file."});if(o===0)return!1;try{const s=(await u.readFile(y,"utf-8")).split(/\r?\n/),c=l.relative(l.dirname(y),e).replace(/\\/g,"/");let f=!1;const m=s.filter(w=>{const W=w.trim();if(W.startsWith("INCLUDE ")){const Y=W.substring(8).trim();if(l.resolve(l.dirname(y),Y)===e)return f=!0,!1}return!0});f||console.warn("Could not find corresponding INCLUDE line for",c);const C=m.join(`
`);await u.writeFile(y,C,"utf-8"),await u.unlink(e);const v=await x(y);return d(t,"root-ink-loaded",v),!0}catch(a){return console.error("Failed to delete include:",a),r.dialog.showErrorBox("Error",`Failed to delete file: ${a.message}`),!1}}function X(t,e){return{ResolveInkFilename:n=>{const o=t?l.dirname(t):process.cwd();return l.resolve(o,n)},LoadInkFileContents:n=>{if(e&&e[n]){let o=e[n];return o&&typeof o=="string"&&o.charCodeAt(0)===65279&&(o=o.slice(1)),o}try{return G.readFileSync(n,"utf-8")}catch(o){return console.error("Failed to load included file:",n,o),""}}}}async function le(t,e,n={}){t&&typeof t=="string"&&t.charCodeAt(0)===65279&&(t=t.slice(1));const o=[];let a=null;try{const i=X(e,n),c=(C,v)=>{o.push(C)};let f;I.CompilerOptions?f=new I.CompilerOptions(e,[],!1,c,i):f={sourceFilename:e,fileHandler:i,errorHandler:c},new I.Compiler(t,f).Compile()}catch(i){o.length===0&&console.error("Compilation failed (unexpected):",i),a=i}const s=o.map(i=>{const c=i.includes("WARNING")?4:8,f=i.match(/^(?:ERROR: )?(?:'([^']+)' )?line (\d+): (.+)/i);if(f){const[,m,C,v]=f,w=parseInt(C);return{startLineNumber:w,endLineNumber:w,startColumn:1,endColumn:1e3,message:v,severity:c,filePath:m||null}}return{startLineNumber:1,endLineNumber:1,startColumn:1,endColumn:1e3,message:i,severity:c,filePath:null}});if(s.length>0)return s;if(a){let i=1,c="Compiler Error: "+a.message;if(a.message.includes("not a function")||a.message.includes("undefined")){const f=t.split(/\r?\n/);for(let m=0;m<f.length;m++)if(f[m].trim()==="~"){i=m+1,c="Syntax Error: Incomplete logic line. '~' must be followed by code.";break}}return[{startLineNumber:i,endLineNumber:i,startColumn:1,endColumn:1e3,message:c,severity:8}]}return[]}async function ce(t,e,n={}){t&&typeof t=="string"&&t.charCodeAt(0)===65279&&(t=t.slice(1));const o=[],a=X(e,n),s=m=>{o.push(m)};let i;I.CompilerOptions?i=new I.CompilerOptions(e,[],!1,s,a):i={sourceFilename:e,fileHandler:a,errorHandler:s};const f=new I.Compiler(t,i).Compile();if(o.length>0&&console.error("Story compilation warnings/errors:",o),!f)throw new Error("Compilation failed: "+o.join(`
`));return f.ToJson()}let p=null;async function de(t,e){if(p){p.show(),p.focus(),t&&e&&await A(t,e),await g({testWindowOpen:!0});return}const n=await $("test");p=new r.BrowserWindow({title:"Test",width:(n==null?void 0:n.width)||800,height:(n==null?void 0:n.height)||600,x:n==null?void 0:n.x,y:n==null?void 0:n.y,backgroundColor:r.nativeTheme.shouldUseDarkColors?"#1e1e1e":"#ffffff",webPreferences:{preload:l.join(__dirname,"preload.js"),nodeIntegration:!1,contextIsolation:!0},show:!1});const{cleanup:o,update:a}=V(p,"#1e1e1e","#ffffff");if(p.on("move",()=>R("test",p.getBounds())),p.on("resize",()=>R("test",p.getBounds())),p.on("closed",async()=>{o(),p=null,await g({testWindowOpen:!1}),r.ipcMain.emit("rebuild-menu")}),p.once("ready-to-show",async()=>{p.show(),await g({testWindowOpen:!0}),r.ipcMain.emit("rebuild-menu")}),p.webContents.on("did-finish-load",async()=>{a(),t&&e&&await A(t,e)}),process.env.VITE_DEV_SERVER_URL)await p.loadURL(`${process.env.VITE_DEV_SERVER_URL}test-window.html`);else{const s=l.join(__dirname,"../dist/test-window.html");await p.loadFile(s).catch(i=>console.error("Failed to load test-window.html:",i))}}async function A(t,e){if(!p||p.isDestroyed())return;const n=e[t];if(!n){console.error("Root file content not found for path:",t);return}try{const o=await ce(n,t,e);d(p,"start-story",o)}catch(o){console.error("Test compilation failed:",o),d(p,"compilation-error",o.message)}}let h=null,k=null;function ue(t){k=t,r.ipcMain.on("open-search-window",()=>{B()}),r.ipcMain.handle("perform-search",async(e,{query:n,caseSensitive:o})=>await new Promise(a=>{if(!d(k,"request-search-results",{query:n,caseSensitive:o}))return a([]);r.ipcMain.once("search-results-ready",(i,c)=>{a(c)})})),r.ipcMain.on("navigate-to-result",(e,{path:n,line:o,query:a})=>{d(k,"navigate-to-match",{path:n,line:o,query:a})}),r.ipcMain.handle("perform-replace-all",async(e,{query:n,replacement:o,caseSensitive:a})=>await new Promise(s=>{if(!d(k,"request-replace-all",{query:n,replacement:o,caseSensitive:a}))return s(0);r.ipcMain.once("replace-all-complete",(c,f)=>{s(f)})}))}async function B(){if(h&&!h.isDestroyed()){h.show(),h.focus(),d(h,"focus-search-input"),await g({searchWindowOpen:!0});return}const t=k;if(t){const[a,s]=t.getPosition(),[i,c]=t.getSize()}const e=await $("search");h=new r.BrowserWindow({title:"Find In Files",width:(e==null?void 0:e.width)||400,height:(e==null?void 0:e.height)||500,x:e==null?void 0:e.x,y:e==null?void 0:e.y,type:"panel",parent:k,minimizable:!1,maximizable:!1,skipTaskbar:!0,frame:!0,titleBarStyle:"hidden",trafficLightPosition:{x:10,y:10},resizable:!0,alwaysOnTop:!0,backgroundColor:r.nativeTheme.shouldUseDarkColors?"#252526":"#f3f3f3",webPreferences:{preload:l.join(__dirname,"preload.js"),nodeIntegration:!1,contextIsolation:!0},show:!1});const{cleanup:n,update:o}=V(h,"#252526","#f3f3f3");if(h.on("move",()=>R("search",h.getBounds())),h.on("resize",()=>R("search",h.getBounds())),h.on("closed",async()=>{n(),h=null,d(k,"clear-search-highlights"),await g({searchWindowOpen:!1}),k&&await d(k,"rebuild-menu")}),h.once("ready-to-show",async()=>{h.show(),await g({searchWindowOpen:!0}),k&&await d(k,"rebuild-menu")}),h.webContents.on("did-finish-load",()=>{o()}),process.env.VITE_DEV_SERVER_URL)h.loadURL(`${process.env.VITE_DEV_SERVER_URL}search.html`);else{const a=l.join(__dirname,"../dist/search.html");h.loadFile(a).catch(s=>console.error("Failed to load search.html:",s))}}async function M(t){const e=await N(),n=process.platform==="darwin",o=e.length>0?e.map(i=>({label:l.basename(i),click:()=>D(t,i)})):[{label:"No Recent Projects",enabled:!1}];e.length>0&&(o.push({type:"separator"}),o.push({label:"Clear Recently Opened",click:async()=>{await g({recentProjects:[]}),await M(t)}}));const a=[...n?[{label:r.app.name,submenu:[{role:"about"},{type:"separator"},{role:"services"},{type:"separator"},{role:"hide"},{role:"hideOthers"},{role:"unhide"},{type:"separator"},{role:"quit"}]}]:[],{label:"File",submenu:[{label:"New Project...",click:async()=>{d(t,"show-new-project-modal")}},{label:"Open Project...",click:async()=>{const{canceled:i,filePaths:c}=await r.dialog.showOpenDialog(t,{properties:["openFile"],filters:[{name:"Dink Project",extensions:["dinkproj"]}]});!i&&c.length>0&&await D(t,c[0])}},{label:"Open Recent Project",submenu:o},{type:"separator"},{label:"Open Ink Root...",accelerator:"CmdOrCtrl+O",click:async()=>{await openInkRootUI(t)}},{label:"Add New Include...",click:async()=>{Q(t)}},{label:"Save",accelerator:n?"Cmd+S":"Ctrl+S",click:async()=>{d(t,"save-all")}},...n?[]:[{role:"quit"}]]},{label:"Edit",submenu:[{role:"undo"},{role:"redo"},{type:"separator"},{role:"cut"},{role:"copy"},{role:"paste"},{role:"delete"},{type:"separator"},{role:"selectAll"},{type:"separator"},{label:"Find",accelerator:"CmdOrCtrl+F",click:(i,c)=>{d(c,"menu-find")}},{label:"Replace",accelerator:"CmdOrCtrl+Alt+F",click:(i,c)=>{d(c,"menu-replace")}},{type:"separator"},{label:"Find In Files",accelerator:"CmdOrCtrl+Shift+F",click:()=>{B()}},{label:"Replace In Files",accelerator:"CmdOrCtrl+Shift+H",click:()=>{B()}}]},{label:"View",submenu:[{role:"reload"},{role:"forceReload"},{role:"toggleDevTools"},{type:"separator"},{role:"resetZoom"},{role:"zoomIn"},{role:"zoomOut"},{type:"separator"},{label:"Theme",submenu:[{label:"System",type:"radio",checked:r.nativeTheme.themeSource==="system",click:()=>{r.nativeTheme.themeSource="system",g({theme:"system"})}},{label:"Light",type:"radio",checked:r.nativeTheme.themeSource==="light",click:()=>{r.nativeTheme.themeSource="light",g({theme:"light"})}},{label:"Dark",type:"radio",checked:r.nativeTheme.themeSource==="dark",click:()=>{r.nativeTheme.themeSource="dark",g({theme:"dark"})}}]},{type:"separator"},{role:"togglefullscreen"}]},{label:"Test",submenu:[{label:"Start Test",accelerator:"CmdOrCtrl+T",click:()=>{d(t,"trigger-start-test")}}]},{label:"Window",submenu:[{role:"minimize"},{role:"zoom"},...n?[{type:"separator"},{role:"front"},{type:"separator"}]:[{role:"close"},{type:"separator"}],...r.BrowserWindow.getAllWindows().map((i,c)=>({label:i.getTitle()||`Window ${c+1}`,accelerator:n?`Cmd+${c+1}`:`Ctrl+${c+1}`,click:()=>{i.isMinimized()&&i.restore(),i.show(),i.focus()}}))]}],s=r.Menu.buildFromTemplate(a);r.Menu.setApplicationMenu(s)}r.app.setName("Dinky");te(M);let _=null;async function z(){const t=await E();r.nativeTheme.themeSource=t.theme||"system";const e=await $("main"),n=new r.BrowserWindow({title:"Dinky",width:(e==null?void 0:e.width)||800,height:(e==null?void 0:e.height)||600,x:e==null?void 0:e.x,y:e==null?void 0:e.y,webPreferences:{preload:l.join(__dirname,"preload.js"),nodeIntegration:!1,contextIsolation:!0}});_=n,ue(n),await M(n),r.ipcMain.emit("rebuild-menu");const{update:o}=V(n);if(n.webContents.on("did-finish-load",async()=>{o();const a=await N();if(a.length>0){const s=a[0];try{await u.access(s),console.log("Auto-loading last project:",s),await D(n,s);const i=await E();i.searchWindowOpen&&await B(),i.testWindowOpen&&d(n,"trigger-start-test")}catch{console.log("Last project not found or invalid, removing from history:",s),await H(s),await M(n)}}}),process.env.VITE_DEV_SERVER_URL)n.loadURL(process.env.VITE_DEV_SERVER_URL);else{const a=l.join(__dirname,"../dist/index.html");n.loadFile(a).catch(s=>console.error("Failed to load index.html:",s))}n.forceClose=!1,n.on("move",()=>R("main",n.getBounds())),n.on("resize",()=>R("main",n.getBounds())),n.on("close",a=>{n.forceClose||n.webContents.isDestroyed()||(a.preventDefault(),d(n,"check-unsaved"))})}r.ipcMain.on("unsaved-status",(t,e)=>{const n=r.BrowserWindow.fromWebContents(t.sender);if(n)if(!e)n.forceClose=!0,n.close();else{const o=r.dialog.showMessageBoxSync(n,{type:"question",buttons:["Save","Discard","Cancel"],defaultId:0,title:"Unsaved Changes",message:"Do you want to save the changes you made in the project?",detail:"Your changes will be lost if you don't save them.",cancelId:2,noLink:!0});o===0?d(n,"save-and-exit"):o===1&&(n.forceClose=!0,n.close())}});r.ipcMain.on("save-exit-complete",t=>{const e=r.BrowserWindow.fromWebContents(t.sender);e&&(e.forceClose=!0,e.close())});r.ipcMain.on("renderer-log",(t,...e)=>{console.log("[Renderer]",...e)});r.ipcMain.handle("compile-ink",async(t,e,n,o={})=>await le(e,n,o));r.ipcMain.handle("save-files",async(t,e)=>{for(const{path:n,content:o}of e)try{await u.writeFile(n,o,"utf-8")}catch(a){console.error("Failed to save file",n,a)}});r.ipcMain.handle("open-project",async t=>{const e=r.BrowserWindow.fromWebContents(t.sender),{canceled:n,filePaths:o}=await r.dialog.showOpenDialog(e,{properties:["openFile"],filters:[{name:"Dink Project",extensions:["dinkproj"]}]});!n&&o.length>0&&await D(e,o[0])});r.ipcMain.handle("open-ink-root",async t=>{const e=r.BrowserWindow.fromWebContents(t.sender);e&&await ae(e)});r.ipcMain.handle("create-ink-root",async t=>{const e=r.BrowserWindow.fromWebContents(t.sender);if(e)return await ie(e)});r.ipcMain.handle("new-project",async t=>{const e=r.BrowserWindow.fromWebContents(t.sender);d(e,"show-new-project-modal")});r.ipcMain.handle("select-folder",async(t,e)=>{const n=r.BrowserWindow.fromWebContents(t.sender),{canceled:o,filePaths:a}=await r.dialog.showOpenDialog(n,{defaultPath:e,properties:["openDirectory","createDirectory"]});return!o&&a.length>0?a[0]:null});r.ipcMain.handle("create-new-project",async(t,e,n)=>{const o=r.BrowserWindow.fromWebContents(t.sender);return await oe(o,e,n)});r.app.whenReady().then(()=>{z(),r.app.on("activate",()=>{r.BrowserWindow.getAllWindows().length===0&&z()})});r.ipcMain.handle("create-new-include",async(t,e,n)=>{const o=r.BrowserWindow.fromWebContents(t.sender);return await re(o,e,n)});r.ipcMain.handle("open-new-include-ui",t=>{const e=r.BrowserWindow.fromWebContents(t.sender);e&&Q(e)});r.ipcMain.handle("delete-include",async(t,e)=>{const n=r.BrowserWindow.fromWebContents(t.sender);return await se(n,e)});r.ipcMain.handle("start-test",(t,e,n)=>{de(e,n)});r.ipcMain.on("request-test-restart",()=>{d(_,"trigger-start-test")});r.ipcMain.on("rebuild-menu",()=>{_&&M(_)});r.app.on("window-all-closed",()=>{r.app.quit()});let J=!1;r.app.on("before-quit",async t=>{J||(t.preventDefault(),await K(),J=!0,r.app.quit())});
